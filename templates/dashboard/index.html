{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - FotoStudio{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Tarjetas de estadísticas -->
<div class="dashboard-cards">
    <div class="card status-card new">
        <h3>Pedidos Nuevos</h3>
        <div class="number">{{ estadisticas.pedidos_nuevos }}</div>
        <a href="{% url 'pedidos:listar' %}?estado=NUEVO" class="btn btn-sm btn-primary">Ver detalles</a>
    </div>
    <div class="card status-card in-progress">
        <h3>Orden de Producción</h3>
        <div class="number">{{ estadisticas.ordenes_produccion }}</div>
        <a href="{% url 'produccion:listar' %}" class="btn btn-sm btn-primary">Ver detalles</a>
    </div>
    <div class="card status-card completed">
        <h3>Entregados</h3>
        <div class="number">{{ estadisticas.pedidos_entregados }}</div>
        <a href="{% url 'pedidos:listar' %}?estado=ENTREGADO" class="btn btn-sm btn-primary">Ver detalles</a>
    </div>
    <div class="card status-card alert">
        <h3>Stock Bajo</h3>
        <div class="number">{{ estadisticas.stock_bajo }}</div>
        <a href="{% url 'inventario:alertas' %}" class="btn btn-sm btn-primary">Ver detalles</a>
    </div>
</div>

<!-- Alertas -->
{% if alertas_inventario %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Alertas de Inventario</h2>
    </div>
    {% for alerta in alertas_inventario %}
        <div class="alert alert-{% if alerta.stock_actual == 0 %}danger{% else %}warning{% endif %}">
            <strong>{% if alerta.stock_actual == 0 %}Stock Agotado:{% else %}Stock Bajo:{% endif %}</strong> 
            {{ alerta.tipo }} - {{ alerta.producto }} ({{ alerta.stock_actual }} unidades restantes)
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- Sección de Reportes -->
<div class="reports-container">
    <!-- Reporte Financiero -->
    <div class="report-section" id="financial-report">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Ingresos por Servicio</h2>
            </div>
            <div class="chart-container">
                <canvas id="services-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Pedidos recientes -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Pedidos Recientes</h2>
        <a href="{% url 'pedidos:listar' %}" class="btn btn-sm btn-primary">Ver todos</a>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Servicio</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in pedidos_recientes %}
                <tr>
                    <td>{{ pedido.cliente.nombre_completo }}</td>
                    <td>{{ pedido.cliente.get_tipo_display }}</td>
                    <td>{{ pedido.get_tipo_servicio_display }}</td>
                    <td>
                        <span class="badge badge-{% if pedido.estado == 'NUEVO' %}info{% elif pedido.estado == 'PRODUCCION' %}warning{% elif pedido.estado == 'ENTREGADO' %}success{% else %}secondary{% endif %}">
                            {{ pedido.get_estado_display }}
                        </span>
                    </td>
                    <td>{{ pedido.fecha_pedido|date:"d/m/Y" }}</td>
                    <td class="actions">
                        <a href="{% url 'pedidos:detalle' pedido.pk %}" class="btn btn-sm btn-ver"><i class='fas fa-eye'></i></a>
                        <a href="{% url 'pedidos:editar' pedido.pk %}" class="btn btn-sm btn-editar"><i class='fas fa-edit'></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No hay pedidos recientes</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para el gráfico (se pueden pasar desde la vista como JSON)
const serviciosData = {{ ingresos_por_servicio|safe }};

// Crear gráfico de ingresos por servicio
function createServicesChart() {
    const ctx = document.getElementById('services-chart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: serviciosData.labels,
            datasets: [{
                data: serviciosData.data,
                backgroundColor: [
                    '#4e73df',
                    '#1cc88a',
                    '#36b9cc',
                    '#f6c23e'
                ],
                hoverBackgroundColor: [
                    '#2e59d9',
                    '#17a673',
                    '#2c9faf',
                    '#dda20a'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round(((value/total) * 100) * 100) / 100;
                            return `${label}: S/ ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                },
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// Inicializar gráficos cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    createServicesChart();
});
</script>
{% endblock %}
